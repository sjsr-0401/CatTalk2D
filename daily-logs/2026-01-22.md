# 2026-01-22

## 오늘 목표
- LoRA 학습 데이터 생성기 완성
- Unsloth 학습 스크립트 작성
- 500개 샘플 생성 테스트
- **[추가] 고양이다움 시스템 대폭 확장 (BehaviorPlanner, CatMemory, TagScorer)**

## 변경 요약
- TrainingDataGenerator 서비스 생성 (템플릿 기반 합성 데이터 생성)
- AITuningTab에 LoRA 합성 학습 데이터 생성 UI 추가
- Unsloth 학습 스크립트 (train_lora.py) 작성
- 500개 학습 데이터 생성 테스트 성공
- **[NEW] BehaviorPlanner: LLM 호출 전 행동 우선 결정 레이어**
- **[NEW] CatMemoryManager: 경량화된 기억/습관 요약 시스템**
- **[NEW] PromptBuilder 개선: [ACT]/[TEXT] 포맷 강제**
- **[NEW] TagScorer: 필수/금지 태그 기반 평가 시스템**
- **[NEW] CatLikenessScore 확장: 7개 → 11개 요소**
- **[NEW] BenchmarkExport 확장: 행동계획/Memory/TagScore 포함**
- **[UPDATE] ResponseProcessor: [ACT]/[TEXT] 파싱 통합, 행동 폴백 추가**
- **[UPDATE] OllamaAPIManager: BehaviorPlanner/Memory 연동, 확장 API 추가**
- **[UPDATE] CatBehaviorAI: BehaviorPlan 기반 자율 행동 (8개 신규 행동)**

## 변경 파일(핵심)
- `Tools/CatDevTools/Services/TrainingDataGenerator.cs` (신규)
- `Tools/CatDevTools/Views/AITuningTab.xaml`
- `Tools/CatDevTools/ViewModels/MainViewModel.cs`
- `LoraData/action_templates.json` (신규)
- `LoraData/train_lora.py` (신규)
- `LoraData/requirements.txt` (신규)
- **`Assets/_Project/Scripts/Models/BehaviorPlan.cs` (신규)**
- **`Assets/_Project/Scripts/AI/BehaviorPlanner.cs` (신규)**
- **`Assets/_Project/Scripts/Models/CatMemorySnapshot.cs` (신규)**
- **`Assets/_Project/Scripts/Managers/CatMemoryManager.cs` (신규)**
- **`Assets/_Project/Scripts/AI/PromptBuilder.cs` (대폭 개선)**
- **`Assets/_Project/Scripts/AI/ResponseProcessor.cs` (확장 - [ACT]/[TEXT] 파싱)**
- **`Assets/_Project/Scripts/AI/CatBehaviorAI.cs` (확장 - BehaviorPlan 연동)**
- **`Assets/_Project/Scripts/API/OllamaAPIManager.cs` (확장 - 행동 포함 API)**
- **`Tools/CatDevTools/Services/Scoring/TagScorer.cs` (신규)**
- **`Tools/CatDevTools/Services/Scoring/CatLikenessScorer.cs` (확장)**
- **`Tools/CatDevTools/Services/BenchmarkDetailedExporter.cs` (확장)**

## 테스트
- [x] 학습 데이터 500개 생성 성공
- [x] TrustTier 균등 분포 확인 (high:165, low:167, mid:168)
- [x] 행동 묘사 100% 포함 확인
- [ ] Unity Play 10초
- [ ] Console Error 0
- 결과:

---

## 구현 상세

### TrainingDataGenerator 핵심 기능

```csharp
// 조합 변수
- AgeLevels: child, teen, adult
- TrustTiers: low, mid, high
- TimeBlocks: morning, afternoon, evening, night, dawn, deepnight
- NeedTop1Values: food, play, rest, affection, none
- MoodTags: neutral, happy, tired, hungry, bored, playful, grumpy, lonely

// 입력 카테고리
- greeting, question, action_pet, action_play, action_feed, emotion, random

// TrustTier별 응답 템플릿
- Low: 경계, 거리두기 ("흥, 왔구나냥", "건드리지마냥")
- Mid: 츤데레, 중립 ("뭐, 나쁘진 않냥", "오늘만 특별히냥")
- High: 친밀, 애착 ("기다렸어냥!", "골골... 좋아냥~")
```

### 행동 선택 로직

```
1. 시간대 우선 (afternoon/deepnight + tired → sleepy)
2. 욕구 우선 (needTop1 == food → hungry)
3. 신뢰도 기반 (low → ignore/reject, high → affection/active)
4. 기분 기반 (happy/playful → active, grumpy → ignore)
```

### 생성된 데이터 형식

```json
{
  "messages": [
    {"role": "system", "content": "너는 '망고'라는 이름의 고양이..."},
    {"role": "user", "content": "[CONTROL]{\"ageLevel\":\"adult\",\"trustTier\":\"mid\",...}\n[USER]안녕?"},
    {"role": "assistant", "content": "잠깐 봐줄게냥. (질주)"}
  ]
}
```

---

## 학습 노트

### 1. 구현 영역
- **어디를**: LoRA 학습 데이터 생성 파이프라인
- **무엇을**: TrustTier별 응답 톤 분리, 행동 묘사 강제 포함, 컨텍스트 기반 행동 선택

### 2. 객체지향 개념
- **사용된 패턴**:
  - 템플릿 메서드: 응답 생성 시 `{action}` 플레이스홀더 사용
  - 전략 패턴: TrustTier별 다른 응답 사전 선택
  - 팩토리: 컨텍스트 기반 행동 카테고리 결정

### 3. 데이터 품질 규칙 적용
| 규칙 | 구현 |
|------|------|
| 행동 묘사 1개 이상 | ✅ 템플릿에 `{action}` 필수 포함 |
| TrustLow 애교 금지 | ✅ ResponsesLowTrust 별도 정의 |
| TrustHigh 친밀 톤 | ✅ ResponsesHighTrust 별도 정의 |
| 시간대별 행동 분화 | ✅ DetermineActionCategory 로직 |
| 응답 길이 20~80자 | ✅ 템플릿이 1-2문장으로 제한됨 |

### 4. 검증 결과
```
총 생성: 500개
TrustTier 분포:
  - high: 165개 (33%)
  - low: 167개 (33.4%)
  - mid: 168개 (33.6%)
행동 묘사 포함: 500개 (100%)
```

---

## 다음 할 일

### 즉시 (오늘~내일)
- [ ] Unsloth 환경 구축 (Python 3.10 + CUDA)
- [ ] 1차 LoRA 학습 실행 (500개 데이터)
- [ ] 학습 모델 Ollama 등록

### 단기 (이번 주)
- [ ] 학습 모델 벤치마크 비교
- [ ] CatScore 개선 확인
- [ ] 데이터 2000개로 확장

---

## 폴더 구조 (현재)

```
LoraData/
├── action_templates.json    # 행동 묘사 템플릿 (9개 카테고리)
├── train_lora.py           # Unsloth 학습 스크립트
├── requirements.txt        # Python 의존성
└── (AppData에 생성됨)
    └── training_data_500_20260122_0919.jsonl

Assets/_Project/Scripts/
├── AI/
│   ├── BehaviorPlanner.cs   # 행동 우선 결정 레이어 (NEW)
│   ├── PromptBuilder.cs     # [ACT]/[TEXT] 포맷 지원 (개선)
│   ├── ResponseProcessor.cs # [ACT]/[TEXT] 파싱 통합 (확장)
│   ├── CatBehaviorAI.cs     # BehaviorPlan 기반 자율 행동 (확장)
│   └── ControlSchema.cs
├── API/
│   └── OllamaAPIManager.cs  # BehaviorPlanner/Memory 연동 (확장)
├── Models/
│   ├── BehaviorPlan.cs      # 행동 계획 DTO (NEW)
│   ├── CatMemorySnapshot.cs # 기억 스냅샷 DTO (NEW)
│   └── CatState.cs
└── Managers/
    ├── CatMemoryManager.cs  # 기억/습관 관리자 (NEW)
    └── CatStateManager.cs

Tools/CatDevTools/Services/
├── TrainingDataGenerator.cs
├── BenchmarkDetailedExporter.cs  # 확장 (행동계획/Memory/TagScore)
└── Scoring/
    ├── CatLikenessScorer.cs      # 확장 (7개 → 11개 요소)
    ├── TagScorer.cs              # 태그 기반 평가 (NEW)
    └── CatScoreKeywords.cs
```

---

## 고양이다움 시스템 확장 상세

### BehaviorPlanner (행동 우선 결정 레이어)

```
역할: LLM 호출 전에 "이번 턴의 고양이 행동"을 결정
     LLM은 결정자가 아니라 표현자(대사 생성기)가 됨

결정 우선순위:
1. 시간대 기반 (Night/Dawn → 활동적, Afternoon → 졸림)
2. 욕구 기반 (hunger>=70 → food_seek, energy<=30 → rest)
3. 신뢰도 기반 (low → turn_away/ignore, high → approach/cuddle)
4. 민감도 기반 (tired+Pet → reject, stressed+Talk → hiss)

출력: BehaviorPlan DTO
- BehaviorState: Idle/Eating/Playing/Sleeping/Walking 등
- BehaviorHint: zoomies/yawn/food_seek/turn_away 등
- RequiredTags: 응답에 반드시 포함되어야 하는 태그
- ForbiddenTags: 응답에 포함되면 안 되는 태그
- Type: Active/Passive/Seeking/Avoiding/Affectionate/Defensive
```

### CatMemoryManager (기억/습관 요약)

```
역할: 상호작용 기록을 경량화된 요약으로 관리

출력: CatMemorySnapshot
- RecentSummary: "방금 밥을 먹음" (1~2줄)
- OwnerStyleSummary: "자주 놀아주는 편" (1줄)
- HabitSummary: "아침에 밥 달라고 울음" (1줄)

내부 추적:
- HabitCounter: 시간대별 행동 빈도 누적
- 연속 행동 감지 (3회 이상 → 습관 인식)
```

### PromptBuilder 개선 ([ACT]/[TEXT] 포맷)

```
기존: 자유 형식 응답 → 행동 묘사 누락 빈번

개선:
1. [ACT]행동 묘사[/ACT][TEXT]대사[/TEXT] 포맷 강제
2. BehaviorPlan 지시를 프롬프트에 포함
3. CatMemorySnapshot 컨텍스트 주입
4. 파싱 유틸리티 제공 (ParseActTextResponse)

예시 응답:
[ACT]하품을 하며 눈을 비빔[/ACT][TEXT]졸려...냥[/TEXT]
```

### TagScorer (태그 기반 평가)

```
역할: BehaviorPlan의 RequiredTags/ForbiddenTags 준수 여부 평가

점수 체계:
- 필수 태그 매칭: +5점
- 필수 태그 누락: -3점
- 금지 태그 위반: -8점

태그-키워드 매핑 예시:
- "zoomies" → ["우다다", "뛰", "달리", "질주"]
- "purr" → ["골골", "그르렁", "기분 좋"]
- "turn_away" → ["등 돌", "외면", "무시"]
```

### CatLikenessScore 확장 (7개 → 11개)

```
기존 7개 (100점):
1. Routine (0~20): 시간대 일관성
2. Need (0~25): 욕구 우선순위
3. Trust (0~20): 신뢰도 정합성
4. Tsundere (0~10): 츤데레/독립성
5. Sensitivity (0~10): 민감도 타이밍
6. Monologue (0~5): 혼잣말/관찰
7. Action (0~10): 행동 묘사

확장 4개 (40점 추가 → 140점 → 100점 정규화):
8. Memory (0~10): 기억/습관 일관성
9. AgeExpression (0~10): 나이에 맞는 표현
10. EmotionCoherence (0~10): 감정 일관성
11. ContextAwareness (0~10): 상황 인지력
```

### BenchmarkExport 확장

```
추가된 필드:
- BehaviorPlan 정보: state, hint, type, reason, requiredTags, forbiddenTags
- Memory 정보: recentSummary, ownerStyle, habit
- TagScore 정보: total, requiredScore, forbiddenPenalty, compliance, violationRate
- [ACT]/[TEXT] 파싱: parsedAction, parsedText, hasActTextFormat
- CombinedScore: Basic + CatScore + TagScore 종합
```
