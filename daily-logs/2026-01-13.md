# 2026-01-13 작업 일지

## 작업 내용

### 1. 밥 주기 버튼 UI 스타일링 🎨
**목표:** 게임 분위기에 맞는 귀여운 버튼 디자인

**시도한 방법들:**
1. Scene 파일 직접 수정 → Unity 멈춤 문제 발생
2. 코드로 런타임 스타일 적용 (SetupButtonStyle 메서드)
3. Scene 파일 신중하게 수정 → 성공

**최종 결과:**
- 버튼 크기: 120x50
- 배경색: 연한 파스텔 핑크 (RGB: 255, 230, 237)
- 텍스트: 크기 28, Bold, 진한 로즈 핑크 (RGB: 217, 102, 127)
- Hover/Press 색상 변화 적용

**주요 코드:**
```csharp
// FoodBowlUI.cs - Scene 파일 수정으로 스타일 적용
// Main.unity:625-628
m_Colors:
  m_NormalColor: {r: 1, g: 0.9, b: 0.93, a: 1}
  m_HighlightedColor: {r: 1, g: 0.92, b: 0.95, a: 1}
  m_PressedColor: {r: 1, g: 0.85, b: 0.9, a: 1}
```

### 2. 채팅 UI 시스템 구축 💬
**목표:** 고양이가 콘솔 대신 채팅창에서 말하게 만들기

**구현 내용:**

#### 2-1. ChatUI 싱글톤 패턴
```csharp
// ChatUI.cs:17
public static ChatUI Instance { get; private set; }

private void Awake()
{
    if (Instance == null)
    {
        Instance = this;
    }
    else
    {
        Debug.LogWarning("[ChatUI] 중복된 ChatUI 인스턴스가 감지되었습니다.");
        Destroy(gameObject);
    }
}
```

**핵심 개념:**
- **싱글톤 패턴**: 게임 전체에서 단 하나의 ChatUI 인스턴스만 존재
- `Instance` static 프로퍼티로 어디서든 `ChatUI.Instance.AddCatMessage()` 호출 가능
- Awake()에서 중복 체크 및 자동 제거

#### 2-2. 고양이 메시지를 ChatUI로 전송
```csharp
// CatHunger.cs:97-107
else if (catState.IsHungry && !_foodBowl.HasFood && !_hasAskedForFood)
{
    _hasAskedForFood = true;
    Debug.Log("😿 배고파... 밥 좀 줘!");

    // 채팅 UI에 메시지 표시
    if (UI.ChatUI.Instance != null)
    {
        UI.ChatUI.Instance.CatSpeakFirst("배고프당.... 🥺");
    }
}
```

**중복 방지 메커니즘:**
- `_hasAskedForFood` 플래그로 한 번만 메시지 전송
- 밥을 받으면 플래그 초기화 (`_foodBowl.HasFood` 체크)

#### 2-3. 채팅 UI 에셋 준비
**PPT에서 이미지 추출:**
1. baseWork.pptx를 ZIP으로 압축 해제
2. `ppt/media/` 폴더에서 이미지 추출
3. Unity Assets 폴더로 복사

**생성된 에셋:**
- `chat_background.png`: 채팅창 둥근 배경 (1424x627)
- `cat_bubble.png`: 노란색 말풍선
- `user_bubble.png`: 하늘색 말풍선
- `user_icon.png`: '나' 아이콘
- `input_background.png`: 입력창 배경
- 각각 `.meta` 파일 생성 (Unity 인식용)

**PPTX 파일 구조:**
```
baseWork.pptx (ZIP 압축 파일)
├── ppt/
│   └── media/
│       ├── image1.png
│       └── image2.png
└── [Content_Types].xml
```

### 3. 창문 기준 이동 제한 시스템 ⚠️
**문제:** 고양이가 창문 위로도 이동 가능

**해결:**
```csharp
// InputHandler.cs:154-165
Vector3[] corners = new Vector3[4];
windowRect.GetWorldCorners(corners);
Vector3 bottomScreenPos = corners[0]; // 왼쪽 하단

Vector3 worldPos = _mainCamera.ScreenToWorldPoint(
    new Vector3(bottomScreenPos.x, bottomScreenPos.y, 10f)
);
maxY = worldPos.y; // 창문 하단 Y 좌표

// 클릭한 Y가 창문 아래면 그대로, 위면 창문 하단으로 제한
float targetY = Mathf.Min(worldPosition.y, maxY);
```

**핵심 개념:**
- `GetWorldCorners()`: RectTransform의 4개 모서리를 Screen Space 좌표로 반환
  - [0] = 왼쪽 하단, [1] = 왼쪽 상단, [2] = 오른쪽 상단, [3] = 오른쪽 하단
- `Mathf.Min()`: 클릭한 Y와 창문 하단 Y 중 작은 값(더 아래) 선택

## 학습한 Unity 개념

### 싱글톤 패턴 (Singleton Pattern)
```csharp
public class ChatUI : MonoBehaviour
{
    public static ChatUI Instance { get; private set; }

    private void Awake()
    {
        if (Instance == null)
            Instance = this;
        else
            Destroy(gameObject);
    }
}
```

**장점:**
- 전역 접근 가능 (`ChatUI.Instance.AddCatMessage()`)
- 단일 인스턴스 보장
- 의존성 주입 없이 간편한 통신

**단점:**
- 테스트 어려움
- 숨겨진 의존성 생성
- 멀티스레드 환경에서 주의 필요

### PPTX 파일 구조
- PPTX = ZIP 압축 파일
- `unzip` 명령으로 압축 해제 가능
- `ppt/media/` 폴더에 이미지 저장됨

### Unity .meta 파일
- 모든 Asset마다 자동 생성
- GUID로 에셋 추적 (파일명 변경해도 참조 유지)
- Texture Import 설정 포함:
  - `spriteMode: 1` = Single Sprite
  - `textureType: 8` = Sprite (2D and UI)
  - `alphaIsTransparency: 1` = 투명도 지원

## 해결한 문제

### 🐛 Unity Scene 파일 수정 시 멈춤
**증상:** Scene 파일 직접 수정 후 Unity가 응답 없음
**원인:** Scene 파일 형식 오류 또는 과도한 수정
**해결:**
1. Unity 강제 종료
2. 최소한의 수정만 진행
3. 중요한 수정은 코드로 처리

### 🐛 배고픔 메시지 중복 출력
**증상:** 매 프레임마다 "배고프당...." 메시지 추가
**원인:** `Update()` → `CheckAndEat()`가 매 프레임 실행
**해결:** `_hasAskedForFood` 플래그 추가

```csharp
// CatHunger.cs:25
private bool _hasAskedForFood = false;

// 한 번만 메시지 전송
if (catState.IsHungry && !_foodBowl.HasFood && !_hasAskedForFood)
{
    _hasAskedForFood = true;
    ChatUI.Instance.CatSpeakFirst("배고프당.... 🥺");
}

// 밥 받으면 초기화
if (_foodBowl.HasFood)
{
    _hasAskedForFood = false;
}
```

### 🐛 PPT 이미지 추출
**문제:** PPT 파일에서 직접 이미지 추출 불가
**해결:** PPTX를 ZIP으로 인식하여 `unzip` 명령 사용

```bash
unzip -q baseWork.pptx -d pptx_extracted
ls pptx_extracted/ppt/media/
```

## 다음 할 일

### 필수
- [ ] ChatUI Scene 오브젝트 생성 및 배치
- [ ] 메시지 Prefab 2개 생성:
  - [ ] CatMessage Prefab (노란 말풍선 + 고양이 아이콘 + 텍스트)
  - [ ] UserMessage Prefab (하늘 말풍선 + '나' 아이콘 + 텍스트)
- [ ] ChatUI 컴포넌트 연결:
  - [ ] ScrollRect
  - [ ] MessageContainer (Content)
  - [ ] InputField
  - [ ] SendButton
  - [ ] Prefab 참조들
- [ ] 고양이 AI (Ollama) 연동 테스트
- [ ] 채팅 UI 위치/크기 조정 (화면 오른쪽)

### 개선사항
- [ ] 타이핑 효과 (한 글자씩 나타나기)
- [ ] 메시지 페이드인 애니메이션
- [ ] 음성 효과 (메시지 전송 시)
- [ ] 고양이 감정 표현 (이모지, 프로필 변화)

## 코드 개선 사항

### 현재 구조
```
ChatUI (싱글톤)
  ├─ AddCatMessage()
  └─ AddUserMessage()

CatHunger
  └─> ChatUI.Instance.CatSpeakFirst()

CatState
  └─> (향후) ChatUI로 상태 변화 알림
```

### 좋은 점
- 싱글톤으로 간편한 접근
- 중복 메시지 방지
- 코드와 UI 분리

### 개선 가능
- Event 시스템으로 리팩토링 고려
  - `CatStateChanged` 이벤트 → ChatUI가 구독
  - 의존성 역전
- Message 클래스 생성
  - `Message { string text, MessageType type, DateTime timestamp }`
  - 메시지 관리 체계화

## 메모
- Unity Scene 파일은 매우 민감함 → 백업 필수
- PPTX는 ZIP 파일이라 `unzip`으로 내용물 추출 가능
- 싱글톤은 편하지만 테스트하기 어려움
- UI 좌표 변환 시 Canvas Render Mode 확인 필수
- .meta 파일은 GUID가 고유해야 함

## 기타
- 밥 주기 버튼 스타일 완료 ✅
- 채팅 UI 기반 코드 완료 ✅
- 채팅 UI 에셋 준비 완료 ✅
- Scene 구성은 다음 작업 예정
