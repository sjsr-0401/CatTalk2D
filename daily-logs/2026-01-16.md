# 2026-01-16 작업 일지

## 오늘 완료한 작업

### 1. CatState 확장

기존 CatState에 새로운 상태와 성격 시스템 추가.

#### 추가된 상태 변수 (0~100)
| 변수 | 설명 |
|------|------|
| `Hunger` | 배고픔 |
| `Energy` | 에너지 (신규) |
| `Stress` | 스트레스 (신규) |
| `Fun` | 재미/만족도 (신규) |
| `Affection` | 호감도 |

#### 성격(Personality) 시스템 (신규)
| 성격 | 설명 |
|------|------|
| `Playful` | 장난기 |
| `Shy` | 소심함 |
| `Aggressive` | 까칠함 |
| `Curious` | 호기심 |

#### 치즈냥이 프리셋
```csharp
Playful = 80    // +30 from base
Curious = 70    // +20 from base
Aggressive = 60 // +10 from base
Shy = 40        // -10 from base
```

#### 프롬프트용 헬퍼
- `AffectionTier`: "low" / "mid" / "high"
- `MoodSummary`: "hungry" / "stressed" / "bored" / "happy" / "neutral" 등
- `TopPersonalityTraits`: 상위 2개 성격 특성

### 2. CatStateManager 생성

상태 중앙 관리자 (싱글톤).

#### 시간 기반 변화 (매 시간마다)
```csharp
배고픔 += 2
에너지 += 5 (회복)
재미 -= 3
스트레스 -= 2 (자연 감소)
```

#### 상호작용 효과 (규칙 기반)
| 상호작용 | 효과 |
|----------|------|
| 밥주기 | Hunger -40, Stress -5, Affection +1 |
| 만지기 (친밀도 < 30) | Stress +10, Affection -1 |
| 만지기 (친밀도 >= 30) | Stress -10, Affection +2 |
| 놀아주기 | Fun +30, Energy -10, Stress -10, Affection +2 |

### 3. 감정 분석기 (SentimentAnalyzer)

사용자 대화 감정 분석 (키워드 기반).

#### 분석 결과
- **Positive**: 호감도 +1
- **Negative**: 스트레스 +5, 호감도 -1
- **Neutral**: 효과 없음

#### 키워드 예시
```csharp
// 긍정
"귀여워", "좋아", "사랑해", "고마워", "최고"

// 부정
"싫어", "바보", "꺼져", "미워", "짜증나"
```

### 4. 혼잣말 시스템 (MonologueManager)

#### 동작 방식
1. 30~90초 랜덤 간격으로 조건 체크
2. 조건 만족 시 AI로 혼잣말 생성
3. ChatUI에 표시

#### 트리거 조건
- `Hunger > 70`: "배고파냥..."
- `Stress > 70`: "힘들어냥..."
- `Affection > 70`: "기분 좋다냥~"
- `Fun < 30`: "심심해냥..."

### 5. JSON 로그 시스템 (InteractionLogger)

#### 저장 위치
`Application.persistentDataPath/CatLogs/`

#### 로그 구조
```json
{
  "sessionId": "guid",
  "startTime": "2026-01-16 17:00:00",
  "endTime": "2026-01-16 18:00:00",
  "totalRecords": 15,
  "records": [
    {
      "timestamp": "2026-01-16 17:05:00",
      "actionType": "pet",
      "userText": "",
      "aiText": "",
      "state": {
        "hunger": 20,
        "energy": 85,
        "stress": 10,
        "fun": 60,
        "affection": 55,
        "playful": 80,
        "shy": 40,
        "aggressive": 60,
        "curious": 70,
        "mood": "Normal"
      }
    }
  ]
}
```

### 6. 대화 프롬프트 개선

CatState가 프롬프트에 반영되도록 개선.

#### 프롬프트 반영 요소
- 연령 레벨 (Child/Teen/Adult)
- 기분 요약 (hungry, stressed, happy 등)
- 호감도 티어 (low, mid, high)
- 성격 상위 2개
- 시간대 상태

### 7. TimeManager 이벤트 추가

`OnHourChanged` 이벤트 추가 (매 시간마다 호출).

---

## 생성/수정된 파일 목록

### 신규 생성
| 파일 | 역할 |
|------|------|
| `Scripts/Managers/CatStateManager.cs` | 상태 중앙 관리자 |
| `Scripts/Managers/InteractionLogger.cs` | JSON 로그 시스템 |
| `Scripts/Managers/MonologueManager.cs` | 혼잣말 시스템 |
| `Scripts/API/SentimentAnalyzer.cs` | 감정 분석기 |

### 수정됨
| 파일 | 변경 내용 |
|------|-----------|
| `Scripts/Models/CatState.cs` | Energy, Stress, Fun, Personality 추가 |
| `Scripts/API/OllamaAPIManager.cs` | CatState 기반 프롬프트, 감정 분석 연동 |
| `Scripts/Managers/TimeManager.cs` | OnHourChanged 이벤트 추가 |

---

## Unity에서 설정해야 할 것

### 1. GameManager에 컴포넌트 추가
1. Hierarchy에서 `GameManager` 오브젝트 선택 (없으면 생성)
2. 다음 컴포넌트 추가:
   - `CatStateManager`
   - `InteractionLogger`
   - `MonologueManager`

### 2. 기존 컴포넌트 확인
- `CatEventSystem`
- `CatBehaviorController`
- `TimeManager`

---

## 테스트 시나리오

### 1. 상태 시스템 테스트
1. Play 모드 진입
2. Console에서 `[CatState]` 로그 확인
3. 시간 경과 시 배고픔 증가, 재미 감소 확인

### 2. 상호작용 테스트
1. 고양이 클릭 (쓰다듬기) → 호감도 변화 확인
2. 밥 주기 → 배고픔 감소 확인
3. 대화 입력:
   - "귀여워" → 호감도 +1
   - "바보" → 스트레스 +5, 호감도 -1

### 3. 혼잣말 테스트
1. 30~90초 대기
2. 조건 만족 시 채팅창에 혼잣말 출력 확인
3. Console에서 `[MonologueManager]` 로그 확인

### 4. 로그 테스트
1. 몇 번 상호작용 후 게임 종료
2. `%APPDATA%/../LocalLow/[회사명]/[프로젝트명]/CatLogs/` 확인
3. JSON 파일 내용 확인

---

## 아키텍처 다이어그램

```
[사용자 입력]
     │
     ├─── 채팅 ──→ ChatUI ──→ OllamaAPIManager
     │                              │
     │                              ├─→ SentimentAnalyzer (감정 분석)
     │                              └─→ CatStateManager (효과 적용)
     │
     ├─── 클릭 ──→ InputHandler ──→ CatEventSystem
     │                                    │
     └─── 밥주기 ──→ FoodBowlUI ─────────┘
                                          │
                                          ▼
                                 CatStateManager
                                          │
                      ┌───────────────────┼───────────────────┐
                      │                   │                   │
                      ▼                   ▼                   ▼
              InteractionLogger    MonologueManager    CatBehaviorController
              (JSON 저장)          (혼잣말 생성)       (애니메이션/이펙트)
```

---

## 다음 작업 예정

### 분석 도구 (별도 Windows 프로그램)
- [ ] Python/C# WPF로 로그 분석 도구 개발
- [ ] 호감도 변화 그래프
- [ ] 상호작용 빈도 통계
- [ ] AI 파라미터 실시간 조절 UI

### Unity 추가 기능
- [ ] 놀아주기 UI 버튼 추가
- [ ] 개발자 모드 메뉴 (상태 조절)
- [ ] 세이브/로드 시스템

---

## 배운 개념

### 1. 규칙 기반 감정 분석
```csharp
// 키워드 매칭으로 간단하게 구현
HashSet<string> _positiveKeywords = new() { "좋아", "귀여워", ... };
HashSet<string> _negativeKeywords = new() { "싫어", "바보", ... };

foreach (var keyword in _positiveKeywords)
{
    if (text.Contains(keyword)) positiveScore++;
}
```

### 2. 상태 스냅샷 패턴
```csharp
// 현재 상태를 불변 객체로 복사해서 저장
public CatStateSnapshot CreateSnapshot()
{
    return new CatStateSnapshot
    {
        hunger = _hunger,
        energy = _energy,
        // ...
    };
}
```

### 3. JSON 세션 로그
```csharp
// Application.persistentDataPath 사용 (영구 저장)
string logFolder = Path.Combine(Application.persistentDataPath, "CatLogs");
string json = JsonUtility.ToJson(session, true);
File.WriteAllText(filePath, json);
```
