# 2026-01-20 데일리 로그

## 오늘 작업 요약 (전체)
- Control 기반 입력 스키마 정리 및 자동 생성 로직 구축
- 프롬프트 빌더/응답 후처리 모듈 분리 및 적용
- Ollama 호출 파이프라인을 Control 기반으로 재구성 + 재시도/폴백 처리
- 상호작용 로그 확장(LoRA 학습용 필드 포함)
- DevTools UI 3탭 구조 분리 + 로그 분석/AI 튜닝 기능 추가
- Ollama 모델 관리/테스트/다운로드/데이터셋 내보내기/생성 기능 구현
- 고양이 특화 벤치마크(점수형) 및 파이썬 벤치마크 도구 추가
- 학습 데이터 JSONL 출력 경로/파일 준비

---

## 1) 구현한 것 전체 정리 (자세히)

### A. Control 기반 입력 스키마 및 생성기
- 목적: LLM에 보내는 입력을 “문장”이 아니라 “구조화된 데이터(JSON)”로 통일.
- 구성 요소:
  - `ControlInput`: 고양이 정보, 기분, 친밀도, 성격, 시간, 사용자 입력, 출력 규칙을 한 번에 담는 구조체.
  - `StateSnapshot`: 배고픔/에너지/스트레스/재미/친밀도/신뢰 수치 스냅샷.
  - `OutputRules`: 언어/길이/고양이 말끝 같은 출력 규칙.
  - `ControlBuilder`: 현재 게임 상태를 읽어 ControlInput을 자동 생성하고 JSON 직렬화까지 처리.
- 핵심 효과: 프롬프트 품질 안정 + 모델 교체/확장 쉬움.
- 관련 파일: `Assets/_Project/Scripts/AI/ControlSchema.cs`

### B. 프롬프트 빌더 분리
- 목적: ControlInput을 받아 LLM에 넣을 “프롬프트 문장”을 일관된 규칙으로 생성.
- 기능:
  - 일반 대화 프롬프트 생성
  - 혼잣말 프롬프트 생성
  - 기분/친밀도/성격을 한국어 톤으로 변환
- 핵심 효과: 규칙을 한 곳에서 관리 가능, 수정/실험이 쉬움.
- 관련 파일: `Assets/_Project/Scripts/AI/PromptBuilder.cs`

### C. 응답 후처리(ResponseProcessor)
- 목적: LLM 원문을 게임용으로 “정제”해 품질을 보장.
- 처리 규칙:
  - 첫 줄만 사용
  - 첫 문장만 사용
  - 영어 포함 여부 감지
  - 최대 길이 제한
  - 고양이 말끝(냥/냐/야옹) 자동 부착
  - 실패 시 폴백 응답 사용
- 핵심 효과: 짧고 일관된 “고양이 말투” 유지.
- 관련 파일: `Assets/_Project/Scripts/AI/ResponseProcessor.cs`

### D. Ollama 호출 파이프라인 재구성
- 목적: 기존 호출 흐름을 Control 기반으로 전면 교체.
- 흐름:
  1) 사용자 입력 감정 분석
  2) 게임 상태 반영
  3) ControlInput 생성
  4) 프롬프트 생성
  5) Ollama 호출
  6) 응답 후처리
  7) 확장 로그 저장
- 추가 기능:
  - 영어 응답 재시도
  - 실패 시 기분 맞춤 폴백 응답
  - 모델 변경 이벤트(`OnModelChanged`)
- 관련 파일: `Assets/_Project/Scripts/API/OllamaAPIManager.cs`

### E. 상호작용 로그 확장(LoRA 학습용)
- 목적: 학습 가능한 로그를 남기기 위해 대화 기록 확장.
- 추가 필드:
  - `inputControl` (Control JSON)
  - `modelName`
  - `rawResponse` (원문 응답)
  - `finalResponse` (후처리 결과)
  - `score` (사용자 평가 점수)
- 관련 파일: `Assets/_Project/Scripts/Managers/InteractionLogger.cs`

### F. DevTools UI 구조 분리(3탭)
- 목적: 툴 기능을 “개발 도구 / 로그 분석 / AI 튜닝”으로 명확히 분리.
- 탭:
  1) DevTools (게임 상태 확인/변경)
  2) Log Analyzer (세션 로그 통계/차트)
  3) AI Tuning (모델/학습/벤치마크)
- 관련 파일:
  - `Tools/CatDevTools/MainWindow.xaml`
  - `Tools/CatDevTools/Views/DevToolsTab.xaml`
  - `Tools/CatDevTools/Views/LogAnalyzerTab.xaml`
  - `Tools/CatDevTools/Views/AITuningTab.xaml`

### G. 로그 분석 기능
- 기능:
  - 로그 폴더 선택
  - 세션 JSON 목록 로드
  - 통계 카드(최대 친밀도, 최소 스트레스, 총 상호작용 수)
  - 차트(친밀도 추이, 상태 변화, 행동 분포, 성격 레이더)
- 관련 파일:
  - `Tools/CatDevTools/Views/LogAnalyzerTab.xaml`
  - `Tools/CatDevTools/Services/LogParserService.cs`
  - `Tools/CatDevTools/Services/StatisticsService.cs`
  - `Tools/CatDevTools/Models/LogModels.cs`

### H. AI 튜닝 기능
- 기능:
  - Ollama 서버 상태 확인
  - 모델 목록 조회/적용
  - 모델 다운로드(Pull) 및 진행률 표시
  - 프롬프트 테스트
  - LoRA 학습용 dataset.jsonl 내보내기
  - 고양이 특화 벤치마크(점수 기반)
  - 조합 기반 dataset/testset 자동 생성
- 관련 파일:
  - `Tools/CatDevTools/Views/AITuningTab.xaml`
  - `Tools/CatDevTools/ViewModels/MainViewModel.cs`
  - `Tools/CatDevTools/Services/OllamaService.cs`
  - `Tools/CatDevTools/Services/DatasetExporter.cs`
  - `Tools/CatDevTools/Services/DatasetGenerator.cs`
  - `Tools/CatDevTools/Services/BenchmarkRunner.cs`

### I. Python 벤치마크 도구
- 목적: 커맨드라인에서 모델 성능 비교.
- 측정 항목:
  - 한국어 응답 비율
  - 고양이 말끝 사용 비율
  - 평균 응답 시간
  - 평균 응답 길이
- 관련 파일:
  - `Tools/Benchmark/benchmark_models.py`
  - `Tools/Benchmark/README.md`
  - `Tools/Benchmark/requirements.txt`

### J. 학습 데이터 파일 준비
- `training_data.jsonl`, `training_data_extended.jsonl` 생성(현재 비어 있음).
- 관련 파일: 루트 `training_data.jsonl`, `training_data_extended.jsonl`

### K. 런타임 메타 추가
- `RuntimeBootstrap` 메타 파일 추가.
- 관련 파일: `Assets/_Project/Scripts/Core/RuntimeBootstrap.cs.meta`

---

## 2) 초보자용 CS 개념 설명 (필수 포함)

### 2-1. 파이프라인 구조
- 입력 → 처리 → 출력이 일렬로 흐르는 구조를 “파이프라인”이라고 부릅니다.
- 이번 작업은 “ControlInput → Prompt → LLM → ResponseProcessor → 로그 저장” 흐름으로 정리됨.

### 2-2. 관심사 분리(Separation of Concerns)
- 데이터를 만드는 코드, 프롬프트 만드는 코드, 응답 정리 코드, 로그 저장 코드를 분리함.
- 덕분에 어느 부분을 바꿔도 다른 부분에 영향이 적음.

### 2-3. 구조화 데이터(JSON) 사용 이유
- LLM에 “문장”만 주면 유지보수가 어렵고 조건을 놓치기 쉬움.
- 구조화된 JSON은 “상태/기분/룰”을 정확히 전달 가능.

---

## 3) AI 처리 흐름 자세한 설명 (필수 포함)

1. 사용자가 입력한다.
2. 게임 상태(배고픔/에너지/스트레스/친밀도 등)를 읽는다.
3. `ControlInput`을 만든다.
4. `PromptBuilder`가 프롬프트를 만든다.
5. Ollama로 프롬프트를 보내 응답을 받는다.
6. `ResponseProcessor`가 응답을 정리한다.
7. 최종 응답을 출력하고, 로그에 저장한다.

---

## 4) 기능 사용법 정리 (필수 포함)

### 4-1. DevTools 탭 (단계별)
1) Unity 실행  
2) DevTools 실행  
3) 상단 “연결” 버튼 클릭  
4) 연결되면 상태 표시등이 초록색으로 변경됨  
5) 상태 수정: 슬라이더로 배고픔/에너지/스트레스/재미/친밀도/신뢰 조정  
6) “적용” 버튼 클릭 → Unity에 즉시 반영  
7) 날짜 변경: `YYYY-MM-DD` 입력 후 “적용”  
8) 날짜 증감: `+ / -` 버튼으로 일수 증가/감소

### 4-2. Log Analyzer 탭 (단계별)
1) “폴더 선택” 클릭  
2) 로그 폴더 선택 (기본 경로: `%AppData%\..\LocalLow\...\CatLogs`)  
3) 좌측 리스트에서 세션 파일 클릭  
4) 자동 로드 후 통계 카드/차트 표시  
5) 상태 차트 체크박스로 표시 항목 선택  
6) 필요 시 다른 세션 파일 선택해 비교

### 4-3. AI Tuning 탭 (단계별)
1) “새로고침” 클릭 → Ollama 서버 상태/모델 목록 확인  
2) 모델 변경: 모델 선택 → “적용” 클릭  
3) 모델 다운로드: 모델명 입력 → “다운로드” 클릭 → 진행률 확인  
4) 프롬프트 테스트: 입력 → “테스트 실행”  
5) dataset.jsonl 내보내기:  
   - “폴더 선택” → 로그 폴더 지정  
   - “dataset.jsonl 생성” 클릭  
6) 고양이 특화 벤치마크:  
   - 모델명 목록 입력(쉼표로 구분)  
   - “벤치마크 실행” 클릭  
7) 데이터셋 생성기:  
   - 출력 폴더 선택  
   - “dataset.jsonl 생성” 또는 “testset.jsonl 생성” 클릭

---

## 5) LoRA 학습 파이프라인 (단계별)

### 5-1. 데이터 수집
1) Unity에서 실제 플레이하며 대화 로그를 쌓는다.  
2) 로그는 `Application.persistentDataPath/CatLogs`에 저장된다.  

### 5-2. 데이터 내보내기 (DevTools)
1) AI Tuning 탭 → “폴더 선택”으로 CatLogs 폴더 지정  
2) “dataset.jsonl 생성” 클릭  
3) 결과 메시지에서 생성 경로 확인  

### 5-3. 학습 데이터 종류
- `dataset.jsonl`: 기본 학습 데이터(시스템/유저/어시스턴트 구조)  
- `training_data_extended.jsonl`: Control JSON + 모델/원문 응답 포함  

### 5-4. 모델 학습(개념)
1) `dataset.jsonl` 또는 `training_data_extended.jsonl`를 학습 파이프라인에 넣음  
2) LoRA 학습 후 가중치(LoRA Adapter)를 생성  
3) GGUF로 변환해 Ollama에서 불러올 수 있게 준비  

### 5-5. Ollama 적용(개념)
1) Modelfile 작성  
2) `ollama create`로 커스텀 모델 생성  
3) DevTools에서 새 모델 선택 후 적용  

---

## 변경 파일 목록 (요약)
- `Assets/_Project/Scripts/AI/ControlSchema.cs`
- `Assets/_Project/Scripts/AI/PromptBuilder.cs`
- `Assets/_Project/Scripts/AI/ResponseProcessor.cs`
- `Assets/_Project/Scripts/API/OllamaAPIManager.cs`
- `Assets/_Project/Scripts/Managers/InteractionLogger.cs`
- `Assets/_Project/Scripts/Core/RuntimeBootstrap.cs.meta`
- `Tools/CatDevTools/MainWindow.xaml`
- `Tools/CatDevTools/ViewModels/MainViewModel.cs`
- `Tools/CatDevTools/Views/DevToolsTab.xaml`
- `Tools/CatDevTools/Views/LogAnalyzerTab.xaml`
- `Tools/CatDevTools/Views/AITuningTab.xaml`
- `Tools/CatDevTools/Services/LogParserService.cs`
- `Tools/CatDevTools/Services/StatisticsService.cs`
- `Tools/CatDevTools/Services/OllamaService.cs`
- `Tools/CatDevTools/Services/DatasetExporter.cs`
- `Tools/CatDevTools/Services/DatasetGenerator.cs`
- `Tools/CatDevTools/Services/BenchmarkRunner.cs`
- `Tools/CatDevTools/Models/LogModels.cs`
- `Tools/Benchmark/benchmark_models.py`
- `Tools/Benchmark/README.md`
- `Tools/Benchmark/requirements.txt`
- `training_data.jsonl`
- `training_data_extended.jsonl`

---

## 테스트 체크리스트
- [ ] Unity Play 10초
- [ ] Console Error 0
